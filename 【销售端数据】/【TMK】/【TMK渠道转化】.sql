#TMK历史数据#
SELECT date_format(from_unixtime(c.start_time), '%Y-%m-%d') as '日期',
				count(c.customer_number) as '呼出数',
				count(distinct c.customer_number) as '呼出用户数',
				count(distinct c.client_name) as '出席人数',
				sum(if(c.status = 28, 1, 0)) as '接通数',
				sum(if(c.status = 28, 1, 0))/count(c.customer_number) as '接通率',
				avg(if(c.status = 28,c.total_duration,0)) as '接通通话时长'
FROM crm_call_outcome_record c join crm_personnel b 
on c.client_name=b.content
WHERE from_unixtime(c.start_time)>= '2017-09-01' and from_unixtime(c.start_time)<= '2017-12-01'
and b.role like "%TMK%"
GROUP BY date_format(from_unixtime(c.start_time), '%Y-%m-%d')


select date_format(from_unixtime(x.forwarding_time), '%Y-%m-%d') as '日期', 
count(x.tel) as '意向确定总数',
sum(case when x.t<0 then 1 else 0 end) as '未跟进数', 
avg(case when x.t>0 then x.t else NULL end) as '平均跟进时效(H)',
avg(CC_COUNT) as '平均跟进人次' ,
sum(CC_CALL_COUNT) as '累计拨打数',
sum(CC_CALL_CONNECT_COUNT) as '累计接通数',
avg(case when x.CC_CALL_CONNECT_COUNT=0 then x.CC_CALL_COUNT else NULL end) as '未接通号码平均拨打次数',
sum(CC_CALL_CONNECT_COUNT)/sum(CC_CALL_COUNT) as '接通率'
from 
(SELECT tel,forwarding_time,TIMESTAMPDIFF(minute,from_unixtime(forwarding_time),from_unixtime(cc_first_call_time))/60 as t,CC_COUNT,CC_CALL_COUNT,CC_CALL_CONNECT_COUNT
from crm_tmk_cc_lead
where from_unixtime(forwarding_time)>='2017-11-01'
group by tel) as x
group by date_format(from_unixtime(x.forwarding_time), '%Y-%m-%d')


首次拨打接通率
select a.dt,count(a.customer_number) as '首次拨打用户数',sum(if(a.status=28,1,0)) as '首次拨打接通用户数',sum(if(a.status=28,1,0))/count(a.customer_number) AS '用户接通率'
from 
  (select x.customer_number,x.client_name,substring(min(from_unixtime(x.start_time)),1,10) as dt,x.status
   from crm_call_outcome_record x join crm_personnel y
   on x.client_name=y.content
   #where status in (28) #判断接通还是拨打
  group by x.customer_number
  having dt>='2017-11-20') as a
group by a.dt



每月拨打号码总数
select date_format(from_unixtime(start_time), '%Y-%m') as '月份',
count(distinct customer_number) as '拨打用户数'
from crm_call_outcome_record
group by date_format(from_unixtime(start_time), '%Y-%m') 


#分时段数据分析 外呼
SELECT a.d as '日期',a.h as '时段',
       count(a.id) as '呼出数',
       sum(if(a.status = 28, 1, 0))as '接通数',
       avg(if(a.status = 28,a.t,0)) as '接通通话时长',
       count(distinct a.tel) as '呼出用户数',
       count(distinct a.name) as '呼出咨询师数'
from 
(SELECT  date_format(from_unixtime(start_time), '%Y-%m-%d') as d , 
        date_format(from_unixtime(start_time), '%H') as h,
        outcome_id as id,
        client_name as name,
        customer_number as tel,
        status,
        total_duration as t
from crm_call_outcome_record
where date_format(from_unixtime(start_time), '%Y-%m-%d')>='2017-10-06') as a 
group by a.d ,a.h


#TMK消耗新资源数
select a.dt,sum(if(a.profile='内部TMK角色',1,0)) as 'TMK首次拨打用户数',sum(if(a.profile='内部TMK角色' and a.status=28,1,0)) as 'TMK首次拨打接通用户数'
from 
  (select x.customer_number,x.client_name,y.profile,substring(min(from_unixtime(x.start_time)),1,10) as dt,x.status
   from crm_call_outcome_record x left join crm_personnel y
   on x.client_name=y.content
  group by x.customer_number
  having dt>='2017-11-20') as a
group by a.dt



TMK消耗leads（TMK拨打电话数-月累积or日新用户）
select count(distinct a.customer_number) as '拨打用户数'
from 
(select customer_number,client_name,min(from_unixtime(start_time)) as t
from crm_call_outcome_record
where client_name in 
  (SELECT content
  from crm_personnel
  where role like "%TMK%")
group by customer_number,client_name) as a
where a.t>='2017-09-01'



select substring(a.t,1,10) as day ,count(distinct a.customer_number) as '拨打用户数'
from 
(select customer_number,client_name,min(from_unixtime(start_time)) as t
from crm_call_outcome_record
where client_name in 
  (SELECT content
  from crm_personnel
  where role like "%TMK%")
group by customer_number,client_name) as a
where a.t>='2017-10-30'
group by day


TMK拨打用户渠道分布
select source.source,count(distinct tel.customer_number)
from 
(select customer_number
from crm_call_outcome_record
where client_name in  (SELECT content from crm_personnel where role like "%TMK%")
and from_unixtime(start_time)>='2017-09-01'
group by customer_number)  as tel 
left join crm_form_record as source
on tel.customer_number=source.telephone_number
where source.source not like "%内部TMK%"
group by source.source


TMK意向用户渠道分布(手机号码反查，新老系统，crm_form_record & channel)


select source,count(telephone_number)
from crm_form_record
where 
telephone_number in 
(select telephone_number
from crm_form_record where source like "%内部TMK%")
and source not like "%内部TMK%"
group by source


TMK完成试听用户渠道分布

SELECT p.student_user_id
FROM tutor_preorder p 
LEFT JOIN audio_record_info a 
ON p.tutor_record_id = a.tutor_record_id
WHERE from_unixtime(p.start_time) BETWEEN '2017-09-01' AND '2017-11-30'
	AND p.status NOT LIKE 'CANCEL'
	AND p.category <> 'SERIES'
	AND p.name not like '题目%'
	AND p.content not like '内容%'
	AND p.name NOT LIKE '测试%'
	AND p.content NOT LIKE '测试%'
	AND p.tutor_record_id = a.tutor_record_id
	AND from_unixtime(floor(a.start_time/1000)) IS NOT NULL
	AND round((a.end_time-a.start_time)/60000) > 15
	AND p.student_user_id  IN 
	(SELECT user_id
from user_online
where telephone_num in 
(select telephone_number
from crm_form_record where source like "%内部TMK%"))


TMK成单用户渠道分布
SELECT DISTINCT student_user_id,
                count(pid),
                sum(amount/100)
FROM series_order
WHERE (note NOT LIKE '%zyb%')
  AND (name NOT LIKE '%测试%')
  AND (name NOT LIKE '%test%')
  and status ='SUCCESS'
  AND amount/100>100
  and from_unixtime(create_time) BETWEEN '2017-09-01' AND '2017-11-30'
  AND student_user_id  IN 
  (SELECT user_id
from user_online
where telephone_num in 
(select telephone_number
from crm_form_record where source like "%内部TMK%"))



SELECT distinct telephone_number,source
from crm_form_record
where telephone_number in 
(SELECT telephone_num
from user_online
where user_id in 
(141198387, 203091134, 203701832, 183674711, 176343428, 177949175, 230668950, 111685269, 203984058, 203984058, 112856695, 248345562, 250508864, 131589745, 255131697, 64097451, 204966472, 114212839, 167878016, 152729449, 223615257, 119746209, 198257382, 123206185, 132058342, 196449855, 83592382, 240552199, 140715844, 222945184, 142920756, 246890618, 175118840, 110157745, 110157745, 110157745, 60149213, 221355169, 225080062, 241133485, 216706971, 200947915, 86416181, 141684730, 246642953, 88581953, 129121854, 134604266, 182980489, 267159856, 242784851, 258505337, 134962245, 112028390, 99046792, 238711517, 269290193, 239704685, 205092708, 261878559, 234142986, 257933247, 61139474, 251571800, 265751975, 196471553, 50004581, 197612750, 217360932, 217360932, 179985234, 195804767, 145016057, 83485089, 212088489, 212088489, 266410154, 212081516, 167680017, 217579318, 214728387, 214728387, 186702855, 173645238, 203063964, 127890407, 249249962, 168601346, 148495128, 259123597, 191451297, 108044337, 158779220, 163620154, 264154968, 146458537, 262038672, 209904002, 272548693, 171485622, 40122206, 128255302, 274975658, 259398470, 160626419, 160626419, 221873033, 133389539, 273466260, 163724179, 256296017, 100529457, 131207484, 131379985, 177999696, 246996410, 176104712, 265479800, 222355671, 88520583, 228923724, 228923724, 251515959, 251515959, 220199019, 192416820, 154690059, 147775598, 245700781, 189996961, 212746269, 263454723, 223180594, 223180594, 258048007, 263015272, 274426691, 275148387, 183555771, 247888346, 275434109, 230804648, 198591060, 50314965, 259727265, 72885521, 164660423, 164660423, 164660423, 272858469, 272858469, 200329313, 263869512, 241499520, 241499520, 267897132, 266232884, 270456413, 269874348, 269874348, 268948820, 265387574, 272246631, 141618173, 263363219, 270988831, 247092246, 269800248, 269853182, 178848217, 199093667, 116895810, 130585709, 137587608, 122156606, 143939080, 142836453, 126761389, 212166123, 206508588, 140341601, 108883890, 110637400, 114491930, 112525981, 128259881, 200605041, 256443894, 123440151, 258826893, 148844291, 82299584, 93980062, 220288338, 257070514, 247196575, 146448429, 135497304, 123035318, 161163036, 204179777, 183212973, 277000773, 277737004, 275604387, 271472229, 135727926, 275290716, 92518221, 92518221, 275572106, 151907699, 263758419, 273634866, 265744147, 267280240, 67232717, 272829969, 149173314, 276082750, 163098984, 272921549, 274773156, 44919383, 267794608, 205383902, 265789424, 151105728, 198925840, 258254271, 278593733, 262621668, 233930034, 248658853, 56083631, 56083631, 164266686, 153244254, 274095160, 252117784, 190904192, 190904192, 190904192, 274773688, 202525485, 234561537, 220826931, 189670693, 185872213, 256635813, 188605819, 257144139, 260165785, 151448602, 258350202, 259988667, 266826330, 197491150, 198213074, 266266704, 222632368, 260474744, 260474744, 280160359, 187384518, 257085904, 246716274, 244791118, 250151512, 161247947, 262105989, 279313491, 279313491, 227125317, 253356622, 273023465, 272813971, 269550930, 276133670, 277178708, 188177160, 279844199, 266497098, 238598600, 238598600, 268483073, 198984132, 46075400, 201893507, 267006260, 261099844, 261099844, 192015388, 234599556, 271697246, 227287843, 76236114, 177502124, 115029649, 270512938, 167907029, 150805224, 123095700, 113674797, 156085666, 280049931, 267081462, 280088672, 280088672, 262904882, 279360231, 109020462, 267887898, 280279736, 190542774, 3585111, 188148584, 156097864, 107548456, 163937853, 155385630, 257492447, 146462033, 154142555, 258338669, 177921587, 280625251, 237335708, 279661970, 207071748, 112122193, 126224639, 75299167, 253987631, 208134266, 116658690, 256077213, 280752171, 255687637, 204805922, 275004842, 194455824, 268324822, 229585456, 130507524, 281871138, 109128040, 155574718, 204834099, 156508872, 278392656, 280139877, 118431732, 278331704, 281238590, 281256469, 281114900, 270966297, 54344124, 54344124, 54344124, 89729876, 281272011, 281097591, 281255386, 281190425, 281190425, 281207791, 209129011, 281119251, 139717147, 271081570, 281193085, 281169145, 268005508, 261216808, 195847840, 281191983, 280215554, 282163700, 261046758, 215447499, 103060713, 281534325, 281475501, 281447875, 281363933, 281548081, 281368873, 281357568, 283188617, 55725842, 269839141, 281528739, 281502557, 281504818, 281369823, 281745947, 281496135, 281335205, 281763883, 281763883, 281806614, 281518251, 281518251, 281959507, 282057243, 282042784, 261404547, 261404547, 281995721, 281965606, 281597177, 255574416, 72148283, 281724724, 281724724, 281874691, 245277974, 281949722, 283032665, 282095186, 281589539, 281781268, 281775264, 253051672, 205286869, 261964173, 258581261, 258581261, 281694932, 188920193, 281742603, 281822137, 188418004, 281952743, 228151393, 282384613, 282384613, 282732256, 282712705, 282697904, 282436616, 282048123, 282660018, 182526389, 204545242, 283942594, 263077193, 283361783, 282418908, 283012088, 277937416, 277937416, 283194089, 282748976, 259536486, 282601840, 255682051, 242069577, 270474843, 222657087, 258008848, 283821735, 283807694, 283904670, 267299278, 281727764, 282682381, 283880540, 283495372, 180411632, 283588567, 283624515, 121673664, 282781884, 283230398, 282905422, 283562385, 282899228, 283539414, 282918836, 284115133, 283520338, 282365765, 283515588, 283897906, 283714100, 283501471, 283772411, 283690958, 283647220, 266901000, 284132385, 274242030, 281987399, 281677775, 277052605, 292581856, 279293275, 273867293, 283593773, 180365082, 281455152, 286901578, 278259637, 286472786, 270100828, 282444235, 283638803, 284137439, 283874783, 263908329, 284091060, 284061648, 259619953, 167981281, 284282428, 284171164, 123621943, 284357022, 284275474, 284183514, 284183514, 268746717, 285857452, 285857452, 205575764, 284098071, 283629645, 284425897, 284460553, 231729321, 284289287, 284573603, 281486673, 249746109, 284027296, 284032939, 228945802, 285160266, 233708513, 285319562, 120763868, 274034056, 285380780, 284402470, 285154718, 270780192, 285422903, 285422903, 285133780, 285424537, 286499519, 186493000, 285273753, 285285875, 286044925, 286077415, 285964593, 286136961, 285981769, 286105269, 286130102, 285910785, 285079896, 285675907, 286045837, 285712273, 285962636, 285835450, 285334477, 285388855, 286128525, 285880898, 285880898, 286023360, 285703780, 286573220, 286123110, 127349990, 127349990, 286405659, 286285579, 285952908, 286071183, 286344783, 286223069, 286223069, 285883539, 286389034, 285656204, 285656204, 285750520, 286152997, 286398686, 285579007, 285819205, 286203347, 286328880, 285512222, 285631561, 286283242, 285440516, 285124375, 285582712, 286297302, 285560064, 285547581, 285662322, 285634259, 285629395, 285746644, 285754206, 286076598, 285477319, 285600838, 285386974, 285549158, 286540312, 286594025, 286231581, 285418362, 285851999, 286459277, 288644144, 288644144, 276866196, 276866196, 281508561, 285261346, 184301122, 286512078, 263863394, 286164625, 286447858, 287595667, 277439654, 285453094, 215306367, 195608915, 274374878, 284480902, 290469436, 257676177, 140713659, 288274784, 110341646, 73736379, 285718049, 286345391, 285606177, 266040053, 285221883, 287313327, 287529927, 286350996, 287512789, 287044192, 287503517, 287347223, 287265656, 287511611, 287492459, 3278622, 287505417, 287318267, 287322808, 287408232, 287479140, 287339072, 287510053, 284577403, 194549361, 287180365, 287315379, 287533765, 287530193, 287873257, 287752778, 287929991, 287871604, 287871604, 287997156, 287939529, 287884885, 288798253, 271541275, 287880040, 105894810, 288233307, 286302337, 288601793, 287506709, 266223688, 266223688, 287732505, 287760853, 287708831, 287778580, 287743468, 287777630, 287782760, 265795656, 252541313, 214875618, 53769374, 287486436, 287569390, 287569390, 257519066, 279570770, 287146640, 287715709, 279567901, 133935675, 287962614, 156094406, 134846915, 276410633, 283213887, 48097513, 288119288, 272770309, 288226657, 288118737, 288037284, 287316804, 288231217, 287885645, 288184990, 290632475, 271890590, 282419269, 281396309, 281397012, 280982717, 288862264, 288430565, 288127515, 288477020, 288340201, 288396270, 288462162, 287766021, 285937765, 125593611, 288467140, 281517415, 288385459, 284755224, 288327167, 288440350, 288606790, 288662859, 288572343, 288635119, 288648115, 283000631, 65885085, 286056572, 103878530, 181441375, 289484305, 289498973, 288618855, 229528418, 285075868, 284225732, 289252106, 289351590, 289424398, 289136434, 283501661, 284137553, 289403460, 53046234, 53046234, 284759024, 288231122, 289158740, 289369241, 289095394, 286079201, 289205081, 289210002, 288736959, 289224271, 289111810, 289088820, 288915939, 289367189, 288903836, 289228584, 283478937, 288778550, 288778550, 288778550, 288804333, 288873835, 291931125, 291848589))
and source not like "%内部TMK%"












